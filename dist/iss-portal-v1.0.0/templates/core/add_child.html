{% extends "base.html" %}

{% block title %}Add Child{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Add New Child</h1>
            <p class="mt-2 text-sm text-gray-600">Create a new child record</p>
        </div>

        <form id="addChildForm" class="bg-white shadow rounded-lg p-6 space-y-6">
            <!-- Basic Information -->
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="first_name" class="block text-sm font-medium text-gray-700">First Name *</label>
                        <input type="text" name="first_name" id="first_name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="last_name" class="block text-sm font-medium text-gray-700">Last Name *</label>
                        <input type="text" name="last_name" id="last_name" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="date_of_birth" class="block text-sm font-medium text-gray-700">Date of Birth *</label>
                        <input type="date" name="date_of_birth" id="date_of_birth" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="centre" class="block text-sm font-medium text-gray-700">Centre</label>
                        <select name="centre" id="centre" 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">No Centre</option>
                            {% for centre in centres %}
                            <option value="{{ centre.id }}">{{ centre.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Guardian Information -->
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-4">Guardian Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="guardian1_name" class="block text-sm font-medium text-gray-700">Guardian 1 Name</label>
                        <input type="text" name="guardian1_name" id="guardian1_name" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="guardian1_phone" class="block text-sm font-medium text-gray-700">Guardian 1 Phone</label>
                        <input type="tel" name="guardian1_phone" id="guardian1_phone" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="guardian1_email" class="block text-sm font-medium text-gray-700">Guardian 1 Email</label>
                        <input type="email" name="guardian1_email" id="guardian1_email" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Caseload Assignment -->
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-4">Caseload Assignment</h3>
                
                <div class="mb-4">
                    <label for="status" class="block text-sm font-medium text-gray-700">Status *</label>
                    <select name="status" id="status" required 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="active">Active</option>
                        <option value="on_hold">On Hold</option>
                        <option value="non_caseload">Non-Caseload</option>
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Non-caseload children receive services but are not assigned to staff caseloads</p>
                </div>

                {% if is_supervisor_or_admin %}
                <!-- Supervisors/Admins assign to staff -->
                <div id="staffAssignmentSection">
                    <label for="assign_to_staff" class="block text-sm font-medium text-gray-700">Assign to Staff Member *</label>
                    <select name="assign_to_staff" id="assign_to_staff" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select a staff member...</option>
                        {% for staff_member in staff_members %}
                        <option value="{{ staff_member.id }}">{{ staff_member.get_full_name }}</option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Required for active/on-hold children</p>
                </div>
                {% else %}
                <!-- Staff assign to themselves -->
                <div id="selfAssignmentSection">
                    <label class="flex items-center">
                        <input type="checkbox" name="assign_to_self" id="assign_to_self" value="true" checked
                               class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Assign to my caseload</span>
                    </label>
                    <p class="mt-1 text-sm text-gray-500">Uncheck for non-caseload children only</p>
                </div>
                {% endif %}
            </div>

            <!-- Notes -->
            <div>
                <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                <textarea name="notes" id="notes" rows="3" 
                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
            </div>

            <!-- Start Date -->
            <div>
                <label for="start_date" class="block text-sm font-medium text-gray-700">Start Date *</label>
                <input type="date" name="start_date" id="start_date" required 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>

            <!-- Buttons -->
            <div class="flex justify-end gap-3">
                <a href="{% url 'all_children' %}" 
                   class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    Add Child
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Handle status change to show/hide assignment fields
document.getElementById('status').addEventListener('change', function() {
    const status = this.value;
    const staffSection = document.getElementById('staffAssignmentSection');
    const selfSection = document.getElementById('selfAssignmentSection');
    const assignToStaff = document.getElementById('assign_to_staff');
    const assignToSelf = document.getElementById('assign_to_self');
    
    if (status === 'non_caseload') {
        if (staffSection) {
            assignToStaff.value = '';
            assignToStaff.removeAttribute('required');
        }
        if (selfSection) {
            assignToSelf.checked = false;
        }
    } else {
        if (staffSection) {
            assignToStaff.setAttribute('required', 'required');
        }
        if (selfSection) {
            assignToSelf.checked = true;
        }
    }
});

// Handle form submission
document.getElementById('addChildForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    formData.forEach((value, key) => {
        if (key === 'assign_to_self') {
            data[key] = value === 'true';
        } else if (value !== '') {
            data[key] = value;
        }
    });
    
    try {
        const response = await fetch('/api/children/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const child = await response.json();
            window.location.href = `/children/${child.id}/`;
        } else {
            const error = await response.json();
            alert('Error creating child: ' + JSON.stringify(error));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Set default start date to today
document.getElementById('start_date').valueAsDate = new Date();
</script>
{% endblock %}
