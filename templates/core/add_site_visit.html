{% extends 'base.html' %}

{% block title %}Log Site Visit - ISS Portal{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Log Site Visit</h1>
    <p class="mt-2 text-gray-600">Record a general visit to a centre (not specific to a child)</p>
    <p class="mt-1 text-sm text-gray-500"><a href="{% url 'add_visit' %}" class="text-blue-600 hover:text-blue-800">Log a child visit instead</a></p>
</div>

<div class="max-w-2xl mx-auto bg-white shadow rounded-lg p-6">
    <form id="siteVisitForm" class="space-y-6">
        {% csrf_token %}
        
        <!-- Centre Selection (Required) -->
        <div>
            <label for="centre" class="block text-sm font-medium text-gray-700 mb-2">
                Centre <span class="text-red-500">*</span>
            </label>
            <select id="centre" name="centre" required
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <option value="">Select a centre...</option>
                {% for centre in centres %}
                <option value="{{ centre.pk }}">{{ centre.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Visit Date -->
        <div>
            <label for="visit_date" class="block text-sm font-medium text-gray-700 mb-2">
                Visit Date <span class="text-red-500">*</span>
            </label>
            <input type="date" id="visit_date" name="visit_date" required
                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <!-- Time Fields (Mobile-Friendly) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label for="start_time" class="block text-sm font-medium text-gray-700 mb-2">
                    Start Time <span class="text-red-500">*</span>
                </label>
                <input type="time" id="start_time" name="start_time" required
                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div>
                <label for="end_time" class="block text-sm font-medium text-gray-700 mb-2">
                    End Time <span class="text-red-500">*</span>
                </label>
                <input type="time" id="end_time" name="end_time" required
                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
        
        <!-- Duration Display -->
        <div id="durationDisplay" class="hidden p-3 bg-blue-50 rounded-md">
            <span class="text-sm text-blue-800">Duration: <span id="durationText" class="font-semibold"></span></span>
        </div>
        
        <!-- Warning for 7+ hour visits -->
        <div id="durationWarning" class="hidden p-3 bg-red-50 rounded-md border border-red-200">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-800">
                        âš  <strong>Warning:</strong> Visit duration exceeds 7 hours and will be flagged for review.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Visit Type -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Visit Type <span class="text-red-500">*</span>
            </label>
            <div class="space-y-2">
                {% for visit_type in visit_types %}
                <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer">
                    <input type="radio" name="visit_type" value="{{ visit_type.pk }}" required
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                    <span class="ml-3 text-sm text-gray-900">{{ visit_type.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
        
        <!-- Location Description -->
        <div>
            <label for="location_description" class="block text-sm font-medium text-gray-700 mb-2">
                Location Description <span class="text-gray-500 text-xs">(Optional)</span>
            </label>
            <input type="text" id="location_description" name="location_description"
                   placeholder="e.g., Specific area of centre, building, room, etc."
                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <!-- Notes -->
        <div>
            <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                Notes <span class="text-gray-500 text-xs">(Include activities, observations, co-visitors, etc.)</span>
            </label>
            <textarea id="notes" name="notes" rows="4"
                      placeholder="Details about the site visit, activities observed, co-visitors, etc."
                      class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>
        
        <!-- Submit Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 pt-4">
            <button type="submit" 
                    class="flex-1 inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Save Visit
            </button>
            <a href="{% url 'dashboard' %}" 
               class="flex-1 inline-flex justify-center items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('visit_date').value = today;
    document.getElementById('visit_date').setAttribute('max', today);
    
    // Calculate duration when times change
    function calculateDuration() {
        const startTime = document.getElementById('start_time').value;
        const endTime = document.getElementById('end_time').value;
        
        if (startTime && endTime) {
            const start = new Date('2000-01-01 ' + startTime);
            let end = new Date('2000-01-01 ' + endTime);
            
            // Handle overnight visits
            if (end < start) {
                end = new Date('2000-01-02 ' + endTime);
            }
            
            const diff = (end - start) / 1000 / 60 / 60; // hours
            
            if (diff > 0) {
                const hours = Math.floor(diff);
                const minutes = Math.round((diff - hours) * 60);
                
                document.getElementById('durationText').textContent = `${hours}h ${minutes}m`;
                document.getElementById('durationDisplay').classList.remove('hidden');
                
                // Show warning for 7+ hour visits
                if (diff >= 7) {
                    document.getElementById('durationWarning').classList.remove('hidden');
                } else {
                    document.getElementById('durationWarning').classList.add('hidden');
                }
            } else {
                document.getElementById('durationDisplay').classList.add('hidden');
                document.getElementById('durationWarning').classList.add('hidden');
            }
        }
    }
    
    document.getElementById('start_time').addEventListener('change', calculateDuration);
    document.getElementById('end_time').addEventListener('change', calculateDuration);
    
    // Form submission via API
    document.getElementById('siteVisitForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        
        const data = {
            staff: {{ user.pk }},
            visit_date: formData.get('visit_date'),
            start_time: formData.get('start_time'),
            end_time: formData.get('end_time'),
            visit_type: parseInt(formData.get('visit_type')),
            location_description: formData.get('location_description') || '',
            notes: formData.get('notes') || '',
            centre: parseInt(formData.get('centre')) || null,
            child: null
        };
        
        try {
            const response = await fetch('/api/visits/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                window.location.href = '{% url "dashboard" %}';
            } else {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    alert('Error saving visit: ' + JSON.stringify(errorData));
                } else {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    alert('Server error occurred. Please try again.');
                }
            }
        } catch (error) {
            alert('Error saving visit: ' + error.message);
        }
    });
</script>
{% endblock %}
