# ISS Portal - Deployment Package

This package contains everything needed to deploy the ISS Portal application in a production environment using Docker.

## Deployment Options

**Option 1: Docker Hub (Recommended for Production)**
- Pull pre-built images from Docker Hub
- Fastest deployment (~2 minutes)
- No build time required
- Smaller download size
- See [DOCKERHUB_DEPLOYMENT.md](DOCKERHUB_DEPLOYMENT.md)

**Option 2: Local Build (Development/Customization)**
- Build images locally from source
- Full control and customization
- No internet required after package download
- This guide covers local build deployment

## What's Included

- ✅ Complete Django application (all modules and dependencies)
- ✅ Docker and Docker Compose configuration
- ✅ Nginx reverse proxy setup
- ✅ Automated deployment scripts
- ✅ Database migration scripts
- ✅ Backup and restore utilities
- ✅ Systemd service configuration
- ✅ Comprehensive documentation

## Important: Fresh Database

**This package starts with a CLEAN database:**
- No test data is included
- No existing children, visits, or staff records
- Only default visit types are created
- A default admin user is created on first deployment

**Default Admin Credentials:**
```
Username: admin
Password: admin123
```

⚠️ **CHANGE THIS PASSWORD IMMEDIATELY AFTER FIRST LOGIN!**

## Quick Installation

### Prerequisites
- Linux server (Ubuntu 20.04+ recommended)
- Docker Engine 20.10+
- Docker Compose 2.0+
- 2GB RAM minimum (4GB recommended)
- 20GB disk space minimum

### Installation Steps

1. **Extract the package:**
   ```bash
   tar -xzf iss-portal-vX.X.X.tar.gz
   cd iss-portal-vX.X.X
   ```

2. **Verify checksum (recommended):**
   ```bash
   sha256sum -c ../iss-portal-vX.X.X.tar.gz.sha256
   ```

3. **Run quick installer:**
   ```bash
   chmod +x install.sh
   ./install.sh
   ```
   
   The installer will prompt you for:
   - **Domain/IP** for ALLOWED_HOSTS (default: localhost)
   - **Database name** (default: iss_portal_db)
   - **Database username** (default: iss_user)
   - **Database password** (required, with confirmation)
   - **Timezone** (default: America/Toronto)
   
   Then automatically:
   - Generate SECRET_KEY using openssl
   - Generate FIELD_ENCRYPTION_KEY using Python cryptography
   - Save all settings to .env file
   - Make scripts executable
   - Optionally run full deployment
   
   **Note:** Key generation uses `docker run --rm python:3.11-slim` which doesn't require the ISS Portal image to be built yet.

4. **Or manually configure:**
   ```bash
   # Create .env file
   cp env.example .env
   nano .env

   # Make scripts executable
   chmod +x *.sh

   # Deploy
   ./deploy.sh
   ```

5. **Access the application:**
   - URL: http://your-server-ip
   - Login: admin / admin123
   - **Change the password immediately!**

## Environment Configuration

**The install.sh script will interactively prompt for all required configuration:**

✅ **Automatically configured during installation:**
- Domain/IP (ALLOWED_HOSTS) - Default: localhost
- Database name - Default: iss_portal_db  
- Database username - Default: iss_user
- Database password - Required input with confirmation
- Timezone - Default: America/Toronto
- SECRET_KEY - Auto-generated with openssl
- FIELD_ENCRYPTION_KEY - Auto-generated with Python cryptography

**You can also manually edit .env after installation:**

```bash
# Edit .env file
nano .env
```

**If you need to manually generate keys later:**

```bash
# SECRET_KEY
openssl rand -base64 50

# FIELD_ENCRYPTION_KEY (doesn't require ISS Portal image)
docker run --rm python:3.11-slim bash -c \
  "pip install -q cryptography && python -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\""
```

**Example .env configuration:**

```bash
# Django Settings
SECRET_KEY=<auto-generated-during-installation>
DEBUG=False
ALLOWED_HOSTS=localhost  # Or your-domain.com (set during installation)

# Database (all configured during installation)
POSTGRES_DB=iss_portal_db
POSTGRES_USER=iss_user
POSTGRES_PASSWORD=<your-secure-password>

# Encryption
FIELD_ENCRYPTION_KEY=<auto-generated-during-installation>

# Timezone (set during installation)
TZ=America/Toronto
```

## Production Deployment

For production environments, use the production configuration:

```bash
# Deploy with production settings
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Check status
docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps

# View logs
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f
```

The production configuration includes:
- Log rotation (10MB max, 3-5 files)
- Resource limits (CPU/memory)
- Enhanced security (no exposed ports)
- Optimized Gunicorn settings
- Always-restart policy

## Management Commands

```bash
# Check application status
./status.sh

# Create backup
./backup.sh

# Start services
./start.sh

# Stop services
./stop.sh

# Upgrade to new version
./upgrade.sh
```

## Initial Setup Tasks

After first login, you should:

1. **Change admin password:**
   - Login at http://your-server-ip
   - Click profile → Change Password

2. **Create additional users:**
   - Go to Admin → Users
   - Create staff, supervisor, and auditor accounts
   - Assign appropriate roles

3. **Configure centres:**
   - Add your organization's centres/locations
   - Set up centre contact information

4. **Test encryption:**
   ```bash
   docker-compose exec web python manage.py verify_encryption
   ```

5. **Enable auto-start (optional):**
   ```bash
   sudo cp iss-portal.service /etc/systemd/system/
   sudo systemctl enable iss-portal
   sudo systemctl start iss-portal
   ```

## Data Migration from Existing System

If you have an existing ISS Portal installation:

1. **Backup old database:**
   ```bash
   # On old server
   ./backup.sh
   ```

2. **Copy backup to new server:**
   ```bash
   scp backups/backup-YYYY-MM-DD_*.tar.gz newserver:/path/to/backups/
   ```

3. **Restore on new server:**
   ```bash
   # On new server, after deployment
   tar -xzf backups/backup-YYYY-MM-DD_*.tar.gz
   docker-compose exec -T db psql -U iss_user iss_portal_db < database.sql
   
   # Copy media files if any
   cp -r media_files/* media/
   ```

4. **Verify encryption key:**
   Ensure the FIELD_ENCRYPTION_KEY in .env matches your old installation!

## Documentation

- **DEPLOYMENT.md** - Complete deployment guide with troubleshooting
- **MANIFEST.txt** - Complete file listing and package information
- **VERSION** - Package version and build information
- **CSV_IMPORT_FORMAT.md** - CSV import file format guide

## Security Checklist

Before going live:

- [ ] Changed default admin password
- [ ] Generated new SECRET_KEY
- [ ] Generated new FIELD_ENCRYPTION_KEY
- [ ] Updated ALLOWED_HOSTS in .env
- [ ] Changed all database passwords
- [ ] Configured firewall (UFW or iptables)
- [ ] Enabled HTTPS/SSL (see DEPLOYMENT.md)
- [ ] Backed up encryption keys securely
- [ ] Tested backup and restore procedure
- [ ] Reviewed user roles and permissions
- [ ] Disabled DEBUG mode (DEBUG=False)

## Support

For detailed information:
- **Deployment Guide:** See DEPLOYMENT.md
- **Application Guide:** See README.md in the package
- **Project Status:** See PROJECT_STATUS.md for features and limitations

## Architecture

```
┌─────────────────────────────────────────────────┐
│                   Nginx (Port 80/443)            │
│              Reverse Proxy & Static Files        │
└──────────────────┬──────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────┐
│            Django Web App (Gunicorn)             │
│          Python 3.11 + Django 4.2.9              │
└──────────────────┬──────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────┐
│              PostgreSQL 15 Database               │
│          Encrypted Field Storage                 │
└──────────────────────────────────────────────────┘
```

## License & Copyright

ISS Portal - Inclusion Support Services Management System
© 2026 All Rights Reserved

---

**Package Version:** See VERSION file  
**Build Date:** See MANIFEST.txt  
**Last Updated:** February 2, 2026
